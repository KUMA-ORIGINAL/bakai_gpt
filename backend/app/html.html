<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Чат с ассистентом</title>
</head>
<body>
    <h1>Выберите ассистента:</h1>
    <select id="assistantSelect">
        <option value="tech">Технический ассистент</option>
        <option value="project">Проектный ассистент</option>
        <option value="default">Обычный ассистент</option>
    </select>

    <br>

    <label for="messageInput">Введите сообщение:</label><br>
    <textarea id="messageInput" rows="4" cols="50"></textarea><br>

    <button onclick="sendMessage()">Отправить</button>

    <div id="chatOutput"></div>

    <script>
       const chatSocket = new WebSocket("ws://localhost:8000/chat_ws/");

        let currentAssistantMessage = ""; // Store the accumulating assistant message

        chatSocket.onopen = () => {
            console.log("WebSocket connection opened");
        };

        chatSocket.onmessage = (event) => {
            const messagePart = event.data; // No need to parse JSON here, it's already a string.
            currentAssistantMessage += messagePart; // Accumulate the message parts

            const chatOutput = document.getElementById("chatOutput");
            // Find the last <p> element (or create one if it doesn't exist)
            let lastParagraph = chatOutput.querySelector("p:last-of-type");
            if (!lastParagraph) {
                lastParagraph = document.createElement("p");
                chatOutput.appendChild(lastParagraph);
            }
            lastParagraph.innerHTML = `<strong>Ассистент:</strong> ${currentAssistantMessage}`; // Update the content
        };

        chatSocket.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        chatSocket.onclose = () => {
            console.log("WebSocket connection closed");
            currentAssistantMessage = ""; // Reset for the next message
        };

        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;
            const assistantType = document.getElementById("assistantSelect").value; // Get selected assistant type

            if (message.trim() === "") {
                return;
            }

            const messageToSend = JSON.stringify({ message: message, assistant_type: assistantType }); // Important: Stringify JSON

            chatSocket.send(messageToSend);
            const chatOutput = document.getElementById("chatOutput");
            chatOutput.innerHTML += `<p><strong>Вы:</strong> ${message}</p>`;
            messageInput.value = "";
        }
    </script>
</body>
</html>